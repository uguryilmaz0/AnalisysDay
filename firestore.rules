rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users koleksiyonu
    match /users/{userId} {
      // Kullanıcı kendi kaydını okuyabilir veya admin tüm kayıtları okuyabilir
      // Username ile arama yapabilmek için herkes okuyabilir (sadece gerekli fieldlar)
      // Login ve kayıt için username kontrolü gerektiğinden genel okuma izni
      allow read: if true;

      // Sadece kayıt sırasında yazılabilir + username unique olmalı
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.username is string &&
                       request.resource.data.username.size() >= 3;

      // Kullanıcılar kendi verilerini güncelleyebilir (email notifications vs)
      // Adminler tüm kullanıcıları güncelleyebilir
      allow update: if request.auth != null && (
                       request.auth.uid == userId ||
                       (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                    );

      // Kullanıcılar kendi hesaplarını silebilir VEYA adminler başka kullanıcıları silebilir
      allow delete: if request.auth != null && (
                       request.auth.uid == userId ||
                       (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                    );
    }

    // Daily Analysis koleksiyonu
    match /daily_analysis/{analysisId} {
      // Premium üyeler veya adminler okuyabilir
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isPaid == true ||
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
                     );

      // Sadece adminler yazabilir, güncelleyebilir, silebilir
      allow write: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Payment Requests koleksiyonu
    match /payment_requests/{requestId} {
      // Kullanıcı kendi taleplerini görebilir, adminler hepsini görebilir
      allow read: if request.auth != null &&
                     (resource.data.userId == request.auth.uid ||
                      (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));

      // Kullanıcılar kendi taleplerini oluşturabilir
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // Sadece adminler güncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // System Logs koleksiyonu (Admin SDK only - API routes kullanır)
    match /system_logs/{logId} {
      // Client-side ASLA yazamaz (sadece Firebase Admin SDK via API routes)
      // Admin SDK security rules'u bypass eder, bu yüzden false bırakılabilir
      allow create: if false;
      
      // Sadece adminler okuyabilir
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Sadece adminler güncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Image Tracking koleksiyonu (Admin SDK only - API routes kullanır)
    match /image_tracking/{trackingId} {
      // Client-side ASLA yazamaz (sadece Firebase Admin SDK via API routes)
      allow create: if false;
      
      // Sadece adminler okuyabilir
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Sadece adminler güncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Login Logs koleksiyonu (Admin SDK only - API routes kullanır)
    match /login_logs/{logId} {
      // Client-side ASLA yazamaz (sadece Firebase Admin SDK via API routes)
      allow create: if false;
      
      // Sadece adminler okuyabilir
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Sadece adminler güncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users koleksiyonu
    match /users/{userId} {
      // KullanÄ±cÄ± kendi kaydÄ±nÄ± okuyabilir veya admin tÃ¼m kayÄ±tlarÄ± okuyabilir
      // Username ile arama yapabilmek iÃ§in herkes okuyabilir (sadece gerekli fieldlar)
      // Login ve kayÄ±t iÃ§in username kontrolÃ¼ gerektiÄŸinden genel okuma izni
      // Referral sistemi iÃ§in de okuma izni gerekli (referral code ile kullanÄ±cÄ± bulma)
      allow read: if true;

      // Sadece kayÄ±t sÄ±rasÄ±nda yazÄ±labilir + username unique olmalÄ±
      allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.username is string &&
                       request.resource.data.username.size() >= 3;

      // KullanÄ±cÄ±lar kendi verilerini gÃ¼ncelleyebilir (email notifications, referralCode vs)
      // Adminler tÃ¼m kullanÄ±cÄ±larÄ± gÃ¼ncelleyebilir
      // Referral sistemi iÃ§in referredUsers ve premiumReferrals gÃ¼ncellenebilir
      allow update: if request.auth != null && (
                       request.auth.uid == userId ||
                       (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                    );

      // KullanÄ±cÄ±lar kendi hesaplarÄ±nÄ± silebilir VEYA adminler baÅŸka kullanÄ±cÄ±larÄ± silebilir
      allow delete: if request.auth != null && (
                       request.auth.uid == userId ||
                       (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
                    );
    }

    // Daily Analysis koleksiyonu
    match /daily_analysis/{analysisId} {
      // Premium Ã¼yeler veya adminler okuyabilir
      // ğŸ Trial Ã¼yelik veya Ã¶deme ile aktif abonelik kontrolÃ¼
      allow read: if request.auth != null && 
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) && (
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
                       (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscriptionEndDate != null &&
                        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.subscriptionEndDate > request.time)
                     );

      // Sadece adminler yazabilir, gÃ¼ncelleyebilir, silebilir
      allow write: if request.auth != null &&
                      exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Payment Requests koleksiyonu
    match /payment_requests/{requestId} {
      // KullanÄ±cÄ± kendi taleplerini gÃ¶rebilir, adminler hepsini gÃ¶rebilir
      allow read: if request.auth != null &&
                     (resource.data.userId == request.auth.uid ||
                      (exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));

      // KullanÄ±cÄ±lar kendi taleplerini oluÅŸturabilir
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;

      // Sadece adminler gÃ¼ncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // System Logs koleksiyonu (Admin SDK only - API routes kullanÄ±r)
    match /system_logs/{logId} {
      // Client-side ASLA yazamaz (sadece Firebase Admin SDK via API routes)
      // Admin SDK security rules'u bypass eder, bu yÃ¼zden false bÄ±rakÄ±labilir
      allow create: if false;
      
      // Sadece adminler okuyabilir
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Sadece adminler gÃ¼ncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Login Logs koleksiyonu (Admin SDK only - API routes kullanÄ±r)
    match /login_logs/{logId} {
      // Client-side ASLA yazamaz (sadece Firebase Admin SDK via API routes)
      allow create: if false;
      
      // Sadece adminler okuyabilir
      allow read: if request.auth != null &&
                     exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                     get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      
      // Sadece adminler gÃ¼ncelleyebilir/silebilir
      allow update, delete: if request.auth != null &&
                               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
